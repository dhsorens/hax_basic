name: CI

on:
  pull_request:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  extract-and-verify:
    name: Extract to Lean and verify
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      
      - name: Set up Cachix
        uses: cachix/cachix-action@v15
        with:
          name: hax
          skipPush: true
          extraPullNames: fstar-nix-versions, z3-nix-versions
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install hax
        run: |
          nix profile install github:hacspec/hax
      
      - name: Install Lean
        run: |
          # Install Lean 4 (lake is included)
          nix profile install nixpkgs#lean4
          # Verify installation
          lean --version
          lake --version
      
      - name: Verify hax installation
        run: |
          cargo hax --version
      
      - name: Extract Rust to Lean
        run: |
          cargo hax into lean
          # Verify extraction succeeded
          if [ ! -f "proofs/lean/extraction/Hax_basic.lean" ]; then
            echo "Error: Lean extraction failed - Hax_basic.lean not found"
            exit 1
          fi
      
      - name: Verify and update lakefile.toml
        working-directory: proofs/lean
        run: |
          # If lakefile still uses path, convert to git
          if grep -q 'path = ' lakefile.toml; then
            echo "Converting lakefile.toml from path to git dependency"
            # Remove the path line and add git lines after name = "Hax"
            sed -i '/path = /d' lakefile.toml
            sed -i '/name = "Hax"/a\
  git.url = "https://github.com/cryspen/hax"\
  git.subDir = "hax-lib/proof-libs/lean"\
  rev = "main"' lakefile.toml
          fi
          echo "Current lakefile.toml:"
          cat lakefile.toml
      
      - name: Build Lean code
        working-directory: proofs/lean
        run: |
          # Clean any cached lake dependencies to ensure fresh fetch
          lake clean
          # Update dependencies
          lake update
          # Build the Lean code
          lake build

